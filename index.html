<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Grafik rezerwacji sto≈Ç√≥w</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  deleteDoc,
  doc,
  onSnapshot,
  updateDoc,
  Timestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* üî• FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyAQ4zC44HnolVdACeEEgvTXU9cwEqTlP9k",
  authDomain: "grafik-bilard.firebaseapp.com",
  projectId: "grafik-bilard",
  storageBucket: "grafik-bilard.appspot.com",
  messagingSenderId: "537235636172",
  appId: "1:537235636172:web:712fb2c543751569072769"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* üé® KOLORY */
const colors = {
  c1: "#2196f3",
  c2: "#4caf50",
  c3: "#ff9800",
  c4: "#f44336"
};

let calendars = [];
let currentDate = new Date();

const usersMap = {
  "dorotalukomska99@gmail.com": "Dorota",
  "merkurytilt@gmail.com": "Pawe≈Ç"
};

let currentUserName = "";

/* üîÅ SPRAWDZANIE NAK≈ÅADANIA */
function isOverlapping(events, start, end, ignoreId) {
  return events.some(e =>
    e.id !== ignoreId &&
    start < e.end &&
    end > e.start
  );
}

/* üìÖ AKTUALIZACJA NAPISU Z DATƒÑ */
function updateDateLabel(date) {
  const formatter = new Intl.DateTimeFormat("pl-PL", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric"
  });

  document.getElementById("currentDate").textContent =
    formatter.format(date);
}

/* üß† KALENDARZ */
function createCalendar(id, stol, color) {
  const cal = new FullCalendar.Calendar(document.getElementById(id), {
timeZone: 'local',
    initialView: "timeGridDay",
    locale: "pl",
    allDaySlot: false,
    selectable: true,
    editable: true,
    eventResizableFromStart: true,
    nowIndicator: true,
    slotMinTime: "16:00:00",
    slotMaxTime: "26:00:00",
slotDuration: "00:15:00",
snapDuration: "00:15:00",
    height: "auto",
    initialDate: currentDate,
    headerToolbar: false,

    select: async (info) => {

  const minutes = Math.round((info.end - info.start) / (1000 * 60));

  const allowedDurations = [
    30, 60, 90, 120, 150,
    180, 210, 240, 270, 300
  ];

  if (!allowedDurations.includes(minutes)) {
    alert(
      "Dozwolone czasy:\n" +
      "30, 60, 90, 120, 150, 180, 210, 240, 270 lub 300 minut"
    );
    return;
  }

 
      const name = prompt("Kto rezerwuje?");
      if (!name) return;

      const events = cal.getEvents();
      if (isOverlapping(events, info.start, info.end)) {
        alert("Ten st√≥≈Ç jest ju≈º zajƒôty");
        return;
      }

      await addDoc(collection(db, "rezerwacje"), {
  nazwa: name,
  start: Timestamp.fromDate(info.start),
  end: Timestamp.fromDate(info.end),
  stol,
  createdBy: currentUserName
});

    },
dateClick: async (info) => {
  const start = new Date(info.date);
start.setMinutes(Math.round(start.getMinutes() / 15) * 15);
start.setSeconds(0);
start.setMilliseconds(0);

 const duration = prompt(
  "Na ile czasu?\nWpisz liczbƒô minut:\n30‚Äì300 co 30 minut",
  "120"
);

  if (!duration) return;

 const minutes = parseInt(duration, 10);

const allowedDurations = [
  30, 60, 90, 120, 150,
  180, 210, 240, 270, 300
];

if (!allowedDurations.includes(minutes)) {
  alert(
    "Dozwolone czasy:\n" +
    "30, 60, 90, 120, 150, 180, 210, 240, 270 lub 300 minut"
  );
  return;
}

  const end = new Date(start.getTime() + minutes * 60 * 1000);

  const name = prompt("Kto rezerwuje?");
  if (!name) return;

  const events = cal.getEvents();
  if (isOverlapping(events, start, end)) {
    alert("Ten st√≥≈Ç jest ju≈º zajƒôty");
    return;
  }

  await addDoc(collection(db, "rezerwacje"), {
  nazwa: name,
  start: Timestamp.fromDate(start),
  end: Timestamp.fromDate(end),
  stol,
  createdBy: currentUserName
});
},

    eventDidMount: (info) => {
  const now = new Date();
  if (info.event.start < now) {
    info.el.style.opacity = "0.4";
  }

  const who = info.event.extendedProps.createdBy;
  if (who) {
    const badge = document.createElement("div");
    badge.textContent = who;
    badge.style.position = "absolute";
    badge.style.bottom = "2px";
    badge.style.right = "4px";
    badge.style.fontSize = "10px";
    badge.style.opacity = "0.8";

    info.el.appendChild(badge);
}  
    },

    eventDrop: async (info) => {
      const events = cal.getEvents();
      if (isOverlapping(events, info.event.start, info.event.end, info.event.id)) {
        alert("Ten st√≥≈Ç jest ju≈º zajƒôty");
        info.revert();
        return;
      }

      await updateDoc(doc(db, "rezerwacje", info.event.id), {
        start: Timestamp.fromDate(info.event.start),
        end: Timestamp.fromDate(info.event.end)
      });
    },

    eventResize: async (info) => {
      const events = cal.getEvents();
      if (isOverlapping(events, info.event.start, info.event.end, info.event.id)) {
        alert("Ten st√≥≈Ç jest ju≈º zajƒôty");
        info.revert();
        return;
      }

      await updateDoc(doc(db, "rezerwacje", info.event.id), {
        start: Timestamp.fromDate(info.event.start),
        end: Timestamp.fromDate(info.event.end)
      });
    },

    eventClick: async (info) => {
      if (confirm("UsunƒÖƒá rezerwacjƒô?")) {
        await deleteDoc(doc(db, "rezerwacje", info.event.id));
      }
    }
  });

  cal.render();
  calendars.push(cal);

  onSnapshot(collection(db, "rezerwacje"), snap => {
    cal.removeAllEvents();
    snap.forEach(d => {
      const e = d.data();
      if (e.stol !== stol) return;

      cal.addEvent({
  id: d.id,
  title: e.nazwa,
  start: e.start.toDate(),
  end: e.end.toDate(),
  backgroundColor: color,
  borderColor: color,
  textColor: "#fff",
  extendedProps: {
    stol: e.stol,
    createdBy: e.createdBy || ""
  }
});
    });
  });
}

/* üìÖ ZMIANA DATY */
function changeDate(date) {
  const d = new Date(date);
  d.setHours(0, 0, 0, 0);   // ‚Üê TO JEST KLUCZOWE

  currentDate = d;
  calendars.forEach(c => c.gotoDate(d));
  updateDateLabel(d);
}

window.addEventListener("DOMContentLoaded", () => {
  createCalendar("c1", "St√≥≈Ç 1", colors.c1);
  createCalendar("c2", "St√≥≈Ç 2", colors.c2);
  createCalendar("c3", "St√≥≈Ç 3", colors.c3);
  createCalendar("c4", "St√≥≈Ç 4", colors.c4);

  updateDateLabel(currentDate);

  document.getElementById("datePicker").valueAsDate = currentDate;
  document.getElementById("datePicker").addEventListener("change", e => {
    changeDate(new Date(e.target.value));
  });

  document.getElementById("prev").onclick = () => {
    currentDate.setDate(currentDate.getDate() - 1);
    changeDate(currentDate);
  };
document.getElementById("today").onclick = () => {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  changeDate(today);
};

  document.getElementById("next").onclick = () => {
    currentDate.setDate(currentDate.getDate() + 1);
    changeDate(currentDate);
  };
});
onAuthStateChanged(auth, user => {
  if (user) {
    const email = user.email;
    currentUserName = usersMap[email] || email;

    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "block";
  } else {
    currentUserName = "";

    document.getElementById("login").style.display = "flex";
    document.getElementById("app").style.display = "none";
  }
});

window.login = function () {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  signInWithEmailAndPassword(auth, email, password)
    .catch(() => alert("B≈Çƒôdny login lub has≈Ço"));
};

window.logout = function () {
  signOut(auth);
};
</script>

<style>
body {
  margin: 0;
  background: #111;
  color: #fff;
  font-family: Arial, sans-serif;
}

header {
  display: flex;
  gap: 15px;
  justify-content: center;
  align-items: center;
  padding: 10px;
}

#currentDate {
  font-size: 18px;
  font-weight: bold;
}

.tables {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  padding: 10px;
}

.table {
  background: linear-gradient(180deg, #1e1e1e, #151515);
  border-radius: 10px;
  padding: 5px;
}

.table h2 {
  text-align: center;
  margin: 5px 0;
}

.fc-scroller {
  overflow: hidden !important;
}

input[type="date"], button {
  background: #222;
  color: #fff;
  border: 1px solid #444;
  padding: 6px 10px;
  border-radius: 6px;
}
.fc-timegrid-slot[data-time$=":00:00"] {
  border-top: 2px solid rgba(255,255,255,0.35);
}
/* WYRA≈πNE LINIE CO PE≈ÅNƒÑ GODZINƒò */
.fc-timegrid-slot[data-time$=":00:00"] {
  border-top: 3px solid rgba(255, 255, 255, 0.55) !important;
}

/* CIE≈ÉSZE LINIE PO≈Å√ìWEK */
.fc-timegrid-slot {
  border-top: 1px solid rgba(255, 255, 255, 0.12);
}
.fc-timegrid-slot[data-time$=":00:00"] {
  border-top: 3px solid rgba(255,255,255,0.6) !important;
  box-shadow: 0 -1px 0 rgba(0,0,0,0.8);
}
</style>
</head>

<body>

<div id="login" style="
  display:none;
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
">
  <div style="background:#1e1e1e; padding:30px; border-radius:12px; width:280px;">
    <h2 style="text-align:center;">Logowanie</h2>
    <input id="email" type="email" placeholder="Email" style="width:100%; margin-bottom:10px;">
    <input id="password" type="password" placeholder="Has≈Ço" style="width:100%; margin-bottom:15px;">
    <button onclick="login()" style="width:100%;">Zaloguj</button>
  </div>
</div>

<div id="app" style="display:none;">
<button onclick="logout()" style="
  position:fixed;
  bottom:10px;
  right:10px;
  z-index:999;
">
  Wyloguj
</button>

<header>
  <button id="prev">‚óÄ</button>

  <button id="today">Dzi≈õ</button>   <!-- ‚¨ÖÔ∏è TO DODAJEMY -->

  <div id="currentDate"></div>
  <input type="date" id="datePicker">
  <button id="next">‚ñ∂</button>
</header>
<div class="tables">
  <div class="table"><h2>St√≥≈Ç 1</h2><div id="c1"></div></div>
  <div class="table"><h2>St√≥≈Ç 2</h2><div id="c2"></div></div>
  <div class="table"><h2>St√≥≈Ç 3</h2><div id="c3"></div></div>
  <div class="table"><h2>St√≥≈Ç 4</h2><div id="c4"></div></div>
</div>

<div id="summary" style="
  padding: 15px;
  text-align: center;
  background: #111;
  font-size: 18px;
">
</div>

</body>
</html>