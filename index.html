<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Grafik rezerwacji sto≈Ç√≥w</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  deleteDoc,
  doc,
  onSnapshot,
  updateDoc,
  Timestamp,
getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* üî• FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyAQ4zC44HnolVdACeEEgvTXU9cwEqTlP9k",
  authDomain: "grafik-bilard.firebaseapp.com",
  projectId: "grafik-bilard",
  storageBucket: "grafik-bilard.appspot.com",
  messagingSenderId: "537235636172",
  appId: "1:537235636172:web:712fb2c543751569072769"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* üé® KOLORY */
const colors = {
  c1: "#2196f3",
  c2: "#4caf50",
  c3: "#ff9800",
  c4: "#f44336"
};


let currentDate = new Date();
let calendar;
const usersMap = {
  "dorotalukomska99@gmail.com": "Dorota",
  "merkurytilt@gmail.com": "Pawe≈Ç"
};

let currentUserName = "";



/* üîÅ SPRAWDZANIE NAK≈ÅADANIA */
function isOverlapping(events, start, end, ignoreId) {
  return events.some(e =>
    e.id !== ignoreId &&
    start < e.end &&
    end > e.start
  );
}

/* üìÖ AKTUALIZACJA NAPISU Z DATƒÑ */
function updateDateLabel(date) {
  const formatter = new Intl.DateTimeFormat("pl-PL", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric"
  });

  document.getElementById("currentDate").textContent =
    formatter.format(date);
}



/* üìÖ ZMIANA DATY */
function changeDate(date) {
  const d = new Date(date);
  d.setHours(0, 0, 0, 0);

  currentDate = d;
  calendar.gotoDate(d);
  updateDateLabel(d);
}

window.addEventListener("DOMContentLoaded", () => {
calendar = new FullCalendar.Calendar(
  document.getElementById("calendar"),
  {
    timeZone: "local",
    initialView: "resourceTimeGridDay",
    locale: "pl",
    selectable: true,
    editable: true,
    eventResizableFromStart: true,
    nowIndicator: true,
    slotMinTime: "16:00:00",
    slotMaxTime: "26:00:00",
    slotDuration: "00:15:00",
    snapDuration: "00:15:00",
    height: "auto",
    initialDate: currentDate,
    headerToolbar: false,

    resources: [
      { id: "1", title: "St√≥≈Ç 1" },
      { id: "2", title: "St√≥≈Ç 2" },
      { id: "3", title: "St√≥≈Ç 3" },
      { id: "4", title: "St√≥≈Ç 4" }
    ],

    select: async (info) => {
      const minutes = Math.round((info.end - info.start) / (1000 * 60));

      const allowedDurations = [
        30, 60, 90, 120, 150,
        180, 210, 240, 270, 300
      ];

      if (!allowedDurations.includes(minutes)) {
        alert("Dozwolone czasy:\n30‚Äì300 co 30 minut");
        return;
      }

      const name = prompt("Kto rezerwuje?");
      if (!name) return;

      await addDoc(collection(db, "rezerwacje"), {
        nazwa: name,
        start: Timestamp.fromDate(info.start),
        end: Timestamp.fromDate(info.end),
        resourceId: info.resource.id,
        createdBy: currentUserName
      });
    },

    eventDrop: async (info) => {
      await updateDoc(doc(db, "rezerwacje", info.event.id), {
        start: Timestamp.fromDate(info.event.start),
        end: Timestamp.fromDate(info.event.end),
        resourceId: info.event.getResources()[0].id
      });
    },

    eventResize: async (info) => {
      await updateDoc(doc(db, "rezerwacje", info.event.id), {
        start: Timestamp.fromDate(info.event.start),
        end: Timestamp.fromDate(info.event.end)
      });
    },

    eventClick: async (info) => {
      if (confirm("UsunƒÖƒá rezerwacjƒô?")) {
        await deleteDoc(doc(db, "rezerwacje", info.event.id));
      }
    }
  }
);

calendar.render();

  updateDateLabel(currentDate);


  document.getElementById("datePicker").valueAsDate = currentDate;
  document.getElementById("datePicker").addEventListener("change", e => {
    changeDate(new Date(e.target.value));
  });

  document.getElementById("prev").onclick = () => {
    currentDate.setDate(currentDate.getDate() - 1);
    changeDate(currentDate);
  };
document.getElementById("today").onclick = () => {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  changeDate(today);
};

  document.getElementById("next").onclick = () => {
    currentDate.setDate(currentDate.getDate() + 1);
    changeDate(currentDate);
  };
});
onAuthStateChanged(auth, user => {
  if (user) {
    const email = user.email;
    currentUserName = usersMap[email] || email;

    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "block";
  } else {
    currentUserName = "";

    document.getElementById("login").style.display = "flex";
    document.getElementById("app").style.display = "none";
  }
});

window.login = function () {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  signInWithEmailAndPassword(auth, email, password)
    .catch(() => alert("B≈Çƒôdny login lub has≈Ço"));
};

window.logout = function () {
  signOut(auth);
};
</script>

<style>
body {
  margin: 0;
  background: #111;
  color: #fff;
  font-family: Arial, sans-serif;
}

header {
  display: flex;
  gap: 15px;
  justify-content: center;
  align-items: center;
  padding: 10px;
}

#currentDate {
  font-size: 18px;
  font-weight: bold;
}

.tables {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  padding: 10px;
}

.table {
  background: linear-gradient(180deg, #1e1e1e, #151515);
  border-radius: 10px;
  padding: 5px;
}

.table h2 {
  text-align: center;
  margin: 5px 0;
}

.fc-scroller {
  overflow: hidden !important;
}

input[type="date"], button {
  background: #222;
  color: #fff;
  border: 1px solid #444;
  padding: 6px 10px;
  border-radius: 6px;
}
/* LINIE CO 15 MIN */
.fc-timegrid-slot {
  border-top: 3px solid rgba(255, 255, 255, 0.4);
}

/* LINIE CO 30 MIN */
.fc-timegrid-slot[data-time$=":30:00"] {
  border-top: 4px solid rgba(255, 255, 255, 0.65);
}

/* LINIE PE≈ÅNYCH GODZIN */
.fc-timegrid-slot[data-time$=":00:00"] {
  border-top: 5px solid rgba(255, 255, 255, 0.9) !important;
}
</style>
</head>

<body>

<div id="login" style="
  display:none;
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
">
  <div style="background:#1e1e1e; padding:30px; border-radius:12px; width:280px;">
    <h2 style="text-align:center;">Logowanie</h2>
    <input id="email" type="email" placeholder="Email" style="width:100%; margin-bottom:10px;">
    <input id="password" type="password" placeholder="Has≈Ço" style="width:100%; margin-bottom:15px;">
    <button onclick="login()" style="width:100%;">Zaloguj</button>
  </div>
</div>

<div id="app" style="display:none;">
<button onclick="logout()" style="
  position:fixed;
  bottom:10px;
  right:10px;
  z-index:999;
">
  Wyloguj
</button>

<header>
  <button id="prev">‚óÄ</button>

  <button id="today">Dzi≈õ</button>   <!-- ‚¨ÖÔ∏è TO DODAJEMY -->

  <div id="currentDate"></div>
  <input type="date" id="datePicker">
  <button id="next">‚ñ∂</button>
</header>
<div style="padding:10px;">
  <div id="calendar"></div>
</div>


<div id="summary" style="
  padding: 15px;
  text-align: center;
  background: #111;
  font-size: 18px;
">
</div>

</body>
</html>